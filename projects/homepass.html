<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js navy">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Homepass - Thought machine</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../notes.html"><strong aria-hidden="true">2.</strong> Notes</a></li><li class="chapter-item expanded "><a href="../programming/index.html"><strong aria-hidden="true">3.</strong> Programming</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../programming/raspberry.html"><strong aria-hidden="true">3.1.</strong> Raspberry</a></li><li class="chapter-item expanded "><a href="../programming/bash.html"><strong aria-hidden="true">3.2.</strong> Bash</a></li><li class="chapter-item expanded "><a href="../programming/python.html"><strong aria-hidden="true">3.3.</strong> Python</a></li></ol></li><li class="chapter-item expanded "><a href="../server/index.html"><strong aria-hidden="true">4.</strong> Server</a></li><li class="chapter-item expanded "><a href="../projects/index.html"><strong aria-hidden="true">5.</strong> Projects</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../projects/homepass.html" class="active"><strong aria-hidden="true">5.1.</strong> Homepass</a></li></ol></li><li class="chapter-item expanded "><a href="../games/index.html"><strong aria-hidden="true">6.</strong> Games</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../games/playing.html"><strong aria-hidden="true">6.1.</strong> Playing</a></li><li class="chapter-item expanded "><a href="../games/finished.html"><strong aria-hidden="true">6.2.</strong> Finished</a></li></ol></li><li class="chapter-item expanded "><a href="../books.html"><strong aria-hidden="true">7.</strong> Books</a></li><li class="chapter-item expanded "><a href="../watching.html"><strong aria-hidden="true">8.</strong> Watching</a></li><li class="chapter-item expanded "><a href="../trading.html"><strong aria-hidden="true">9.</strong> Trading</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Thought machine</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/lttviet/wiki" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#homepass" id="homepass">Homepass</a></h1>
<h2><a class="header" href="#streetpass" id="streetpass">StreetPass</a></h2>
<p>3DS has a built-in feature <a href="http://www.nintendo.com/3ds/built-in-software/streetpass">StreetPass</a> which lets nearby users to exchange data from games and applications.
This is great if you live in a big city where there are a lot of 3DS devices.
However, if you live in a small town, you would be lucky to just get a handful of streetpasses monthly.</p>
<h2><a class="header" href="#streetpass-relay" id="streetpass-relay">StreetPass Relay</a></h2>
<p>Due to that, Nintendo introduced another feature called <a href="http://en-americas-support.nintendo.com/app/answers/detail/a_id/709/%7E/streetpass-relay-overview">StreetPass Relay</a>.
Every 3DS device has a whitelist of public wifi AP which it can automatically connect to.
If connected, some data will be sent and stored on Nintendo server.
When another 3DS user connects to the same AP, Nintendo server will send the stored data to the latter device.
Consequently, 3DS devices don't have to be in close proximity to exchange data.</p>
<p>The whitelist contains the SSID and MAC of public wifi AP.
Thus, some nice people figured out ways to create homemade StreetPass relays by spoofing MAC and SSID<sup class="footnote-reference"><a href="#1">1</a></sup>.
The basic idea to create a public wifi AP with the same SSID and MAC as in the whitelist.</p>
<p>For Raspberry Pi, there is <a href="http://www.spillmonkey.com/?page_id=169">SpillPass-Pi2</a> which work automatically when you plug in.
You only need a wifi dongle <code>wlan0</code> which support mac spoof and a wired internet connection <code>eth0</code>.</p>
<p>My setup is slightly different because I don't have a wired connection to the home router.
What I have is 2 wifi dongles, <code>wlan0</code> and <code>wlan1</code>.
The idea is still the same, but instead of <code>eth0</code> bridge to <code>wlan0</code>, I have <code>wlan1</code> connected to the internet and <code>wlan0</code> as wifi AP.
All the traffic are forwarded to/from <code>wlan0</code> to <code>wlan1</code>.</p>
<h2><a class="header" href="#setup" id="setup">Setup</a></h2>
<p>I used <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian Jessie Lite</a> image.
I don't have external keyboard or monitor so desktop on Raspberry Pi is unnecessary.
Installed the image on the SD card by either dd or <a href="https://etcher.io/">Etcher</a>, then added your wifi network to <code>/etc/wpa_supplicant/wpa_supplicant.conf</code>.<sup class="footnote-reference"><a href="#2">2</a></sup></p>
<pre><code class="language-bash">#/etc/wpa_supplicant/wpa_supplicant.conf
network={
    ssid=&quot;testing&quot;
    psk=&quot;testingPassword&quot;
}
</code></pre>
<p>Updated and installed softwares:</p>
<pre><code class="language-bash">sudo apt update &amp;&amp; sudo apt upgrade
sudo apt -y install hostapd dnsmasq haveged iptable-persistent sqlite3
</code></pre>
<p>I used this wonderful <a href="https://help.ubuntu.com/community/WifiDocs/WirelessAccessPoint#Configuring_networking">guide</a> to setup forwarding.</p>
<h3><a class="header" href="#interfaces" id="interfaces">Interfaces</a></h3>
<p>Set <code>wlan0</code> to a static ip address <code>10.0.0.1</code>.</p>
<pre><code class="language-bash">#/etc/network/interfaces
auto lo
iface lo inet loopback

iface eth0 inet manual

# AP
allow-hotplug wlan0
iface wlan0 inet static
    address 10.0.0.1
    netmask 255.255.255.0

# wireless
allow-hotplug wlan1
iface wlan1 inet manual
    wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf
</code></pre>
<p>Tell DHCPCD to ignore wlan0.</p>
<pre><code class="language-bash">#/ect/dhcpcd.conf
denyinterfaces wlan0
</code></pre>
<h3><a class="header" href="#hostapd" id="hostapd">Hostapd</a></h3>
<p>Hostapd is an user daemon to start up AP.
In <code>/etc/default/hostapd</code>, uncomment or add the line <code>DAEMON_CONF=/etc/hostapd/hostapd.conf</code>.</p>
<pre><code class="language-bash">#/etc/hostapd/hostapd.conf
#sample hostapd.conf
#overwrite by homepass.sh

ssid=attwifi
bssid=34:bd:c8:db:79:00

interface=wlan0
driver=nl80211

hw_mode=g
channel=6
auth_algs=3
wpa=0
rsn_pairwise=CCMP
beacon_int=100

macaddr_acl=0

wmm_enabled=0
eap_reauth_period=360000000
</code></pre>
<p>You can test if AP is working by running <code>sudo hostapd /etct/hostapd/hostapd</code>.
You should be able to see <code>attwifi</code>.</p>
<p>I use <code>dnsmasq</code> to map IP addresses to MAC addresses.
When 3DS connect to my hotspot, it will be assigned a dynamic IP address.
It is also possible to bind 3DS MAC address to a static IP address.</p>
<pre><code class="language-bash">#/etc/dnsmasq.conf
interface=wlan0
except-interface=wlan1
dhcp-range=10.0.0.2,10.0.0.255,12h
</code></pre>
<h3><a class="header" href="#port-forwarding" id="port-forwarding">Port forwarding</a></h3>
<p>In <code>/etc/sysctl.conf</code>, uncomment <code>net.ipv4.ip_forward=1</code>.</p>
<pre><code class="language-bash">sudo iptables -t nat -A POSTROUTING -o wlan1 -j MASQUERADE
sudo iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i wlan0 -o wlan1 -j ACCEPT
sudo sh -c 'iptables-save &gt; /etc/iptables/rules.v4'
</code></pre>
<p>Start services <code>sudo service hostapd start &amp;&amp; sudo service dnsmasq start</code>.
Reboot Raspberry Pi and test if <code>attwifi</code> can be connected to the internet.</p>
<h3><a class="header" href="#systemd-service-and-timer" id="systemd-service-and-timer">systemd service and timer</a></h3>
<p>I use systemd to run my <code>homepass.sh</code> at boot time and the script will rerun every 5 minutes to change <code>wlan0</code> to new SSID and MAC.</p>
<pre><code class="language-bash">#/etc/systemd/system/homepass.service
[Unit]
Description=Homepass

[Service]
ExecStart=/home/pi/homepass.sh

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code class="language-bash">#/etc/systemd/system/homepass.timer
[Unit]
Description=Run homepass.service every 5 minutes

[Timer]
OnStartupSec=10
OnUnitActiveSec=5min
Unit=homepass.service

[Install]
WantedBy=multi-user.target
</code></pre>
<p>Enable the timer by executing this command</p>
<pre><code class="language-bash">systemctl enable homepass.timer
systemctl start homepass.timer
</code></pre>
<p>A nice feature of using systemd to run the script is we can access the logging easily for debugging</p>
<pre><code class="language-bash">journalctl -u homepass
</code></pre>
<h3><a class="header" href="#homepasssh" id="homepasssh">homepass.sh</a></h3>
<p>This script was modified from orginal script by Semperverus.
You can check out his <a href="https://docs.google.com/document/d/1EvmIwTIjPva5MHSFEIN0qsHtRmdRRiX3WNHu_ThxnOs/edit?pref=2&amp;pli=1#">guide</a> for more details about HomePass.
I took the idea of using sqlite3 to store MAC and SSID in a database from danielhoherd's <a href="https://github.com/danielhoherd/homepass/blob/master/RaspberryPi/homepass.sh">script</a>.</p>
<p>The script is rerun every 5 minutes by systemd.
It stops current running hostapd service.
A new <code>/etc/hostapd/hostapd.conf</code> is generated from querying MAC and SSID from a database.
The hostapd service is then restarted with the new conf file.</p>
<pre><code class="language-bash">#!/bin/bash
service hostapd stop

SLEEP_TIME=300
DB=/home/pi/homepass.db
CONFIG_FILE=/etc/hostapd/hostapd.conf

if [[ ! -e &quot;$CONFIG_FILE&quot; ]] ; then
  touch &quot;$CONFIG_FILE&quot;
fi

read -d '' query &lt;&lt; EOF
SELECT mac, ssid
FROM aps
WHERE last_used &lt; datetime('now', '-2 days') OR last_used IS NULL
ORDER BY random()
LIMIT 1;
EOF

result=$(sqlite3 &quot;$DB&quot; &quot;$query&quot;)
resultArr=(${result//|/ })

MAC=${resultArr[0]}
SSID=${resultArr[1]}

if [[ -z &quot;$MAC&quot; ]] || [[ -z &quot;$SSID&quot; ]] ; then
  echo &quot;missing MAC or SSID&quot;
  exit 1
fi

sqlite3 &quot;$DB&quot; &quot;UPDATE aps SET last_used = datetime('now') WHERE mac = '$MAC'&quot;

cat &gt; $CONFIG_FILE &lt;&lt; EOF
ssid=$SSID
bssid=$MAC

interface=wlan0
driver=nl80211

hw_mode=g
channel=6
auth_algs=3
wpa=0
rsn_pairwise=CCMP
beacon_int=100

macaddr_acl=0

wmm_enabled=0
eap_reauth_period=360000000
EOF

echo &quot;===========================================&quot;
echo &quot;SSID:&quot; $SSID &quot;- BSSID:&quot; $MAC
echo &quot;Time before next change:&quot; $SLEEP_TIME &quot;seconds&quot;
echo &quot;Current time:&quot; $(date)
echo &quot;===========================================&quot;

service hostapd start
</code></pre>
<h2><a class="header" href="#all-files" id="all-files">All files</a></h2>
<p>You can find all my files at my github <a href="https://github.com/lttviet/homepass">repo</a>.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p><a href="https://gbatemp.net/threads/how-to-have-a-homemade-streetpass-relay.352645/">https://gbatemp.net/threads/how-to-have-a-homemade-streetpass-relay.352645/</a></p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p><a href="https://www.raspberrypi.org/documentation/configuration/wireless/wireless-cli.md">https://www.raspberrypi.org/documentation/configuration/wireless/wireless-cli.md</a></p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../projects/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../games/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../projects/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../games/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
